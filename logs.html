<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Patient Edit Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

        @media (min-width: 400px) and (max-width: 480px) {
            .log-time {
                flex-direction: column !important;
                text-align: center;
            }
        }

        @media (max-width: 400px) {
            .log-header {
                flex-direction: column !important;
                text-align: center;
                justify-content: center;
            }
        }

        @media (max-width: 450px) {
            .pagination-container {
                flex-direction: column !important;
                gap: 0.5rem;
            }
        }

        .log-details {
            transition: all 0.3s ease;
        }

        #downloadModal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center shadow">
        <h1 class="text-2xl font-bold">Patient Records</h1>
        <img src="images/logo-placeholder.jpg" alt="Logo" class="h-10 w-auto">
    </header>

    <nav class="bg-blue-600 text-white px-4 py-3 shadow">
        <ul class="flex space-x-4">
            <li><a href="index.html" class="hover:underline">Home</a></li>
            <li><a href="logs.html" class="hover:underline font-semibold">Logs</a></li>
            <li><a href="admin.html" class="hover:underline">Admin</a></li>
        </ul>
    </nav>

    <main class="flex-grow p-4">
        <!-- admin logs -->
        <div class="max-w-7xl mx-auto bg-white shadow rounded p-4 mb-4">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center gap-4 w-full md:w-2/3">
                    <h2 class="text-lg font-semibold uppercase whitespace-nowrap">Admin Logs</h2>
                    <div class="relative w-full max-w-xs">
                        <input id="adminSearchInput" type="text" placeholder="Search User or Patient…" class="w-full border border-gray-300 rounded px-3 py-2 pr-8 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
                        <button id="adminClearSearch" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 text-lg"> &times; </button>
                    </div>
                </div>
                <div class="flex flex-wrap md:flex-nowrap items-center gap-4 w-full md:w-auto">
                    <select id="adminSortSelect" class="border border-gray-300 rounded px-2 sm:px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest First</option>
                        <option value="user-asc">User Name A–Z</option>
                        <option value="user-desc">User Name Z–A</option>
                    </select>
                    <select id="adminDateFilter" class="border border-gray-300 rounded px-2 sm:px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="all">All Time</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                    <button id="adminDownloadCsv" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700" title="Download CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Logs Container -->
            <div id="adminLogsContainer" class="border rounded-lg overflow-hidden"></div>

            <!-- Loading Indicator -->
            <div id="adminLoadingIndicator" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div>
                <p class="mt-2 text-gray-600">Loading logs...</p>
            </div>

            <!-- Empty State -->
            <div id="adminEmptyState" class="hidden text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No logs found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter</p>
            </div>
        </div>

        <!-- patient logs -->
        <div class="max-w-7xl mx-auto bg-white shadow rounded p-4">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center gap-4 w-full md:w-2/3">
                    <h2 class="text-lg font-semibold uppercase whitespace-nowrap">Patient Logs</h2>
                    <div class="relative w-full max-w-xs">
                        <input id="searchInput" type="text" placeholder="Search User or Patient…" class="w-full border border-gray-300 rounded px-3 py-2 pr-8 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
                        <button id="clearSearch" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 text-lg"> &times; </button>
                    </div>
                </div>
                <div class="flex flex-wrap md:flex-nowrap items-center gap-4 w-full md:w-auto">
                    <select id="sortSelect" class="border border-gray-300 rounded px-2 sm:px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest First</option>
                        <option value="user-asc">User Name A–Z</option>
                        <option value="user-desc">User Name Z–A</option>
                    </select>
                    <select id="dateFilter" class="border border-gray-300 rounded px-2 sm:px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="all">All Time</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                    <button id="downloadCsv" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700" title="Download CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Logs Container -->
            <div id="logsContainer" class="border rounded-lg overflow-hidden"></div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div>
                <p class="mt-2 text-gray-600">Loading logs...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No logs found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter</p>
            </div>
        </div>

        <!-- Download Options Modal -->
        <div id="downloadModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-6">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Export Data</h3>
                    <p class="text-sm text-gray-500 mt-1">
                        Select how you want to download your data as a CSV file.
                    </p>
                </div>
                <div class="space-y-3">
                    <button id="downloadCurrentPage"
                            class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg border border-gray-300 text-gray-700 hover:text-gray-800 hover:bg-gray-100 focus:ring-2 focus:ring-gray-300">
                        <span>Current Page Only</span>
                    </button>

                    <button id="downloadAllPages"
                            class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                        <span>All Pages (Full Dataset)</span>
                    </button>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeDownloadModal"
                            class="text-sm font-medium text-gray-500 hover:text-gray-700">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center text-white text-xs sm:text-sm py-6 px-12 mt-8 bg-blue-700">
        <p>Patient Records System © 2025</p>
    </footer>

    <script>
        // --- Shared State Management ---
        const logsState = {
            patient: {
                all: [],
                filtered: [],
                logsPerPage: 10,
                currentPage: 1
            },
            admin: {
                all: [],
                filtered: [],
                logsPerPage: 10,
                currentPage: 1
            }
        };

        // --- Context Configurations ---
        const logConfigs = {
            patient: {
                api: '/api/audit-logs',
                container: 'logsContainer',
                loading: 'loadingIndicator',
                empty: 'emptyState',
                search: 'searchInput',
                clear: 'clearSearch',
                sort: 'sortSelect',
                date: 'dateFilter',
                downloadBtn: 'downloadCsv',
                modal: 'downloadModal',
                downloadCurrent: 'downloadCurrentPage',
                downloadAll: 'downloadAllPages',
                modalClose: 'closeDownloadModal',
                pagination: 'paginationContainer'
            },
            admin: {
                api: '/api/admin-logs',
                container: 'adminLogsContainer',
                loading: 'adminLoadingIndicator',
                empty: 'adminEmptyState',
                search: 'adminSearchInput',
                clear: 'adminClearSearch',
                sort: 'adminSortSelect',
                date: 'adminDateFilter',
                downloadBtn: 'adminDownloadCsv',
                modal: 'downloadModal',
                downloadCurrent: 'downloadCurrentPage',
                downloadAll: 'downloadAllPages',
                modalClose: 'closeDownloadModal',
                pagination: 'adminPaginationContainer'
            }
        };

        // --- Helpers ---
        function getEl(id) {
            return document.getElementById(id);
        }

        function parseLogDate(dateStr, timeStr) {
            if (!dateStr) return new Date(0);
            const [month, day, yearShort] = dateStr.split('/');
            const year = 2000 + parseInt(yearShort);
            return new Date(year, parseInt(month) - 1, parseInt(day));
        }

        //TIME FUNCTION
        function getTimestamp(utcString) {
            if (!utcString) return "N/A";
            const date = new Date(utcString);
            return date.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // --- Fetch Logs ---
        async function fetchLogs(ctx) {
            const cfg = logConfigs[ctx];
            try {
                showLoading(ctx);
                const response = await fetch(cfg.api);
                if (!response.ok) throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                const data = await response.json();
                logsState[ctx].all = data;
                applyFilters(ctx);
            } catch (error) {
                console.error(`Error fetching ${ctx} logs:`, error);
                showError(ctx, 'Failed to load logs. Please try again later.');
            }
        }

        // --- Filters ---
        function applyFilters(ctx) {
            const state = logsState[ctx];
            const cfg = logConfigs[ctx];

            state.filtered = [...state.all];

            // search
            const searchTerm = getEl(cfg.search).value.trim().toLowerCase();
            if (searchTerm) {
                state.filtered = state.filtered.filter(log =>
                    (log.userName || '').toLowerCase().includes(searchTerm) ||
                    (log.patientName || '').toLowerCase().includes(searchTerm) ||
                    (log.adminName || '').toLowerCase().includes(searchTerm) ||
                    (log.targetName || '').toLowerCase().includes(searchTerm)
                );
            }

            // date filter
            const daysFilter = getEl(cfg.date).value;
            if (daysFilter !== 'all') {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - parseInt(daysFilter));
                state.filtered = state.filtered.filter(log => {
                    const logDate = parseLogDate(log.date, log.time);
                    return logDate >= cutoffDate;
                });
            }

            // sorting
            const sortOption = getEl(cfg.sort).value;
            switch (sortOption) {
                case 'recent':
                    state.filtered.sort((a, b) => parseLogDate(b.date, b.time) - parseLogDate(a.date, a.time));
                    break;
                case 'oldest':
                    state.filtered.sort((a, b) => parseLogDate(a.date, a.time) - parseLogDate(b.date, b.time));
                    break;
                case 'user-asc':
                    state.filtered.sort((a, b) => (a.userName || a.adminName).localeCompare(b.userName || b.adminName));
                    break;
                case 'user-desc':
                    state.filtered.sort((a, b) => (b.userName || b.adminName).localeCompare(a.userName || a.adminName));
                    break;
            }

            const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.logsPerPage));
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            if (state.currentPage < 1) state.currentPage = 1;

            renderLogs(ctx);
        }

        // --- Render Logs ---
        function renderLogs(ctx) {
            const state = logsState[ctx];
            const cfg = logConfigs[ctx];
            hideLoading(ctx);

            const container = getEl(cfg.container);
            const emptyState = getEl(cfg.empty);

            const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.logsPerPage));
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            if (state.currentPage < 1) state.currentPage = 1;

            if (state.filtered.length === 0) {
                emptyState.classList.remove('hidden');
                container.innerHTML = '';
                renderPagination(ctx, totalPages);
                return;
            }
            emptyState.classList.add('hidden');

            const startIndex = (state.currentPage - 1) * state.logsPerPage;
            const endIndex = startIndex + state.logsPerPage;
            const paginatedLogs = state.filtered.slice(startIndex, endIndex);

            container.innerHTML = '';
            paginatedLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = 'border-b';

                const displayName = log.userName || log.adminName || 'Unknown';
                const displayId = log.userId || log.adminId || 'N/A';
                const subtitle = log.patientName ? `Patient: ${log.patientName}` : (log.targetName ? `Target: ${log.targetName}` : '');

                logElement.innerHTML = `
                    <div class="log-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-blue-800 font-medium">${displayName.charAt(0)}</span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${displayName} (ID: ${displayId})</div>
                                    <div class="text-sm text-gray-500">${subtitle}</div>
                                </div>
                            </div>
                        </div>
                        <div class="ml-6 flex-shrink-0">
                            <div class="log-time flex flex-row text-sm text-gray-500">
                                <span>${getTimestamp(log.timestamp)}</span>
                            </div>
                            ${log.edits ? `<div class="mt-1 text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${log.edits.length} changes</div>` : ''}
                        </div>
                        <div class="ml-6 flex-shrink-0">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="log-details bg-gray-50 px-4 pb-4 hidden">
                        ${log.edits ? `
                            <div class="pt-2 pb-3 text-sm font-medium text-gray-700">Changes made:</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${log.edits.map(edit => `
                                    <div class="bg-white border rounded p-3 text-sm">
                                        <div class="font-medium text-gray-800">${edit.field}</div>
                                        <div class="mt-1 flex items-center">
                                            <span class="text-gray-500 line-through mr-2">${edit.from || 'N/A'}</span>
                                            <span class="text-green-600 font-medium">${edit.to || 'N/A'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        : `<div class="pt-2 pb-3 text-sm text-gray-700">Action: ${log.action || 'N/A'}</div>`}
                    </div>
                `;

                const header = logElement.querySelector('.cursor-pointer');
                const details = logElement.querySelector('.log-details');
                const arrow = logElement.querySelector('svg');
                header.addEventListener('click', () => {
                    details.classList.toggle('hidden');
                    arrow.classList.toggle('transform');
                    arrow.classList.toggle('rotate-180');
                });

                container.appendChild(logElement);
            });

            renderPagination(ctx, totalPages);
        }

        // --- Pagination ---
        function renderPagination(ctx, totalPages) {
            const state = logsState[ctx];
            const cfg = logConfigs[ctx];
            const container = getEl(cfg.container);

            let pagination = getEl(cfg.pagination);
            if (!pagination) {
                pagination = document.createElement('div');
                pagination.id = cfg.pagination;
                pagination.className = 'pagination-container flex justify-center items-center gap-2 p-4';
                container.parentNode.appendChild(pagination);
            }
            pagination.innerHTML = '';

            // prev
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Prev';
            prevBtn.className = `px-3 py-1 rounded ${state.currentPage === 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white'}`;
            prevBtn.disabled = state.currentPage === 1;
            prevBtn.onclick = () => { state.currentPage--; renderLogs(ctx); };
            pagination.appendChild(prevBtn);

            // page numbers
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `px-3 py-1 rounded ${i === state.currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200'}`;
                btn.onclick = () => { state.currentPage = i; renderLogs(ctx); };
                pagination.appendChild(btn);
            }

            // next
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.className = `px-3 py-1 rounded ${state.currentPage === totalPages ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white'}`;
            nextBtn.disabled = state.currentPage === totalPages;
            nextBtn.onclick = () => { state.currentPage++; renderLogs(ctx); };
            pagination.appendChild(nextBtn);
        }

        // --- Loading / Error ---
        function showLoading(ctx) {
            getEl(logConfigs[ctx].loading).classList.remove('hidden');
            getEl(logConfigs[ctx].empty).classList.add('hidden');
        }
        function hideLoading(ctx) {
            getEl(logConfigs[ctx].loading).classList.add('hidden');
        }
        function showError(ctx, message) {
            hideLoading(ctx);
            getEl(logConfigs[ctx].container).innerHTML = `<div class="text-center py-12 text-red-600">${message}</div>`;
        }

        // --- CSV Download ---
        function downloadCSV(ctx, scope) {
            const state = logsState[ctx];
            let logsToDownload, filename;
            if (scope === 'current') {
                const startIndex = (state.currentPage - 1) * state.logsPerPage;
                const endIndex = startIndex + state.logsPerPage;
                logsToDownload = state.filtered.slice(startIndex, endIndex);
                filename = `${ctx}_logs_page_${state.currentPage}.csv`;
            } else {
                logsToDownload = state.filtered;
                filename = `${ctx}_logs_all_pages.csv`;
            }

            let csvContent = "Name,ID,Target/Patient,Timestamp,Action/Field,From,To\n";
            logsToDownload.forEach(log => {
                const ts = getTimestamp(log.timestamp);
                if (log.edits) {
                    log.edits.forEach(edit => {
                        csvContent += `"${log.userName || log.adminName}","${log.userId || log.adminId}","${log.patientName || log.targetName || ''}","${log.date || ''}","${log.time || ''}","${edit.field}","${edit.from || ''}","${edit.to || ''}"\n`;
                    });
                } else {
                    csvContent += `"${log.adminName}","${log.adminId}","${log.targetName}","${ts}","${log.action}","",""\n`;
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
        }

        let currentDownloadCtx = null;
        // --- Init ---
        function initLogs(ctx) {
            const cfg = logConfigs[ctx];
            getEl(cfg.search).addEventListener('input', () => { logsState[ctx].currentPage = 1; applyFilters(ctx); });
            getEl(cfg.clear).addEventListener('click', () => { getEl(cfg.search).value = ''; logsState[ctx].currentPage = 1; applyFilters(ctx); });
            getEl(cfg.sort).addEventListener('change', () => { logsState[ctx].currentPage = 1; applyFilters(ctx); });
            getEl(cfg.date).addEventListener('change', () => { logsState[ctx].currentPage = 1; applyFilters(ctx); });

            // Open modal
            getEl(cfg.downloadBtn).addEventListener('click', () => {
                if (logsState[ctx].filtered.length === 0) {
                    alert('No logs to download');
                    return;
                }
                currentDownloadCtx = ctx; // 👈 track who opened modal
                getEl(cfg.modal).classList.remove('hidden');
            });

            fetchLogs(ctx);
        }

        getEl('downloadCurrentPage').addEventListener('click', () => {
            if (currentDownloadCtx) downloadCSV(currentDownloadCtx, 'current');
        });
        getEl('downloadAllPages').addEventListener('click', () => {
            if (currentDownloadCtx) downloadCSV(currentDownloadCtx, 'all');
        });
        getEl('closeDownloadModal').addEventListener('click', () => {
            getEl('downloadModal').classList.add('hidden');
        });
        getEl('downloadModal').addEventListener('click', (e) => {
            if (e.target.id === 'downloadModal') getEl('downloadModal').classList.add('hidden');
        });

        document.addEventListener('DOMContentLoaded', () => {
            initLogs('patient');
            initLogs('admin');
        });
    </script>
</body>
</html>
